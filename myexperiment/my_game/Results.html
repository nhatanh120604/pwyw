{{ block title }}Results - Round {{ subsession.round_number }}{{ endblock }} {{
block content }}

<div class="card">
  <div class="card-body">
    <h3 class="card-title">Round {{ subsession.round_number }} Results</h3>

    {{ if is_buyer }}
    <div class="alert alert-primary">
      <h5>Your Role: BUYER</h5>
    </div>
    {{ else }}
    <div class="alert alert-success">
      <h5>Your Role: SELLER</h5>
    </div>
    {{ endif }}
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h4>Summary</h4>

    <div class="row mt-3">
      <div class="col-md-6">
        <div class="card bg-light">
          <div class="card-body">
            <h5 class="card-title">Buyer's Decision</h5>
            <p class="display-4">
              {{ if buyer_decision }} Bought the product {{ else }} Did not buy
              the product {{ endif }}
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card bg-light">
          <div class="card-body">
            <h5 class="card-title">Amount Paid</h5>
            <p class="display-4 text-primary"><span class="count-up" data-value="{{ price_paid }}">0</span> tokens</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h4>Payoff Calculation</h4>

    {{ if is_buyer }}
    <div class="card border-primary">
      <div class="card-body">
        <h5 class="text-primary">Buyer's Payoff</h5>
        {{ if buyer_decision }}
        <p>Initial endowment: <span class="count-up" data-value="{{ endowment }}">0</span> tokens</p>
        <p>Amount paid: -<span class="count-up" data-value="{{ price_paid }}">0</span> tokens</p>
        <p>Product utility: +<span class="count-up" data-value="{{ utility }}">0</span> tokens</p>
        <hr />
        <p class="display-4 text-primary"><span class="count-up" data-value="{{ buyer_payoff }}">0</span> tokens</p>
        {{ else }}
        <p>No purchase was made</p>
        <hr />
        <p class="display-4 text-primary"><span class="count-up" data-value="{{ buyer_payoff }}">0</span> tokens</p>
        {{ endif }}
      </div>
    </div>
    {{ else }}
    <div class="card border-success">
      <div class="card-body">
        <h5 class="text-success">Seller's Payoff</h5>
        {{ if buyer_decision }}
        <p>Amount received: <span class="count-up" data-value="{{ price_paid }}">0</span> tokens</p>
        <p>Production cost: -<span class="count-up" data-value="{{ production_cost }}">0</span> tokens</p>
        <hr />
        <p class="display-4 text-success"><span class="count-up" data-value="{{ seller_payoff }}">0</span> tokens</p>
        {{ else }}
        <p>No sale was made</p>
        <hr />
        <p class="display-4 text-success"><span class="count-up" data-value="{{ seller_payoff }}">0</span> tokens</p>
        {{ endif }}
      </div>
    </div>
    {{ endif }}
  </div>
</div>

{{ if subsession.round_number < C.NUM_ROUNDS }}
<div class="alert alert-warning mt-4">
  <p>
    <strong
      >Round {{ subsession.round_number }} of {{ C.NUM_ROUNDS }}
      complete.</strong
    >
  </p>
  <p>
    Click Next to continue to the next round. You may be assigned a different
    role.
  </p>
</div>
{{ else }}
<div class="alert alert-success mt-4">
  <p><strong>All rounds complete!</strong></p>
  <p>Thank you for participating in the experiment.</p>
</div>
{{ endif }}

<div class="mt-4">{{ next_button }}</div>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        const duration = 2000; // 2 seconds
        const elements = document.querySelectorAll('.count-up');

        elements.forEach(el => {
            const target = parseInt(el.dataset.value);
            if (isNaN(target)) {
                el.innerText = el.dataset.value;
                return;
            }

            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Ease out cubic
                const ease = 1 - Math.pow(1 - progress, 3);

                const current = Math.floor(ease * target);
                el.textContent = current;

                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    el.textContent = target;
                }
            }

            requestAnimationFrame(update);
        });
    });
</script>

{{ endblock }}
